<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.gif">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<noscript>
  <center>
    <b>notice</b>
    <p>javascript required to view this site</p>
    <b>why</b>
    <p>measured improvement in server performance</p>
    <p>awesome incremental search</p>
  </center>
</noscript>
  
<div id=tab>
  <img src="spin.gif">
  <p>This site uses features not available on older iPhones.</a></p>
</div>

<script type=module>


// L A U N C H

  let names = []
  let json = {}
  let inlinks = []
  let infetch = fetch('inlinks.json').then(res => res.json())

  let title = (location.search.match(/\w+/)||["WelcomeVisitors"])[0]
  let database = 'https://proxy.c2.com/wiki/remodel/pages/'
  let options = {titlesearch, fullsearch}

  import {markup} from "./markup.js"

  try {
    [names, json] = await Promise.all([
      fetch('names.txt').then(res => res.text()).then(text => text.split(/\r?\n/)),
      fetch(database+title).then(res => res.json())
    ])
    options.names = names
    window.tab.innerHTML = render(title,json)
    history.pushState({title},'',location.href)
  } catch (err) {
    trouble(err.message)
    window.tab.innerHTML = `page does not exist`
  }

  function trouble (msg) {
    console.error('trouble', msg)
  }


//  L O O P

  document.addEventListener('click', internallinks)

  window.onpopstate = async function(event) {
    console.log('popstate',event.state)
    if (event.state) {
      let title = event.state.title
      json = await fetch(database+title).then(res => res.json())
      window.tab.innerHTML = render(title,json)
    } else {
      history.go(-1)
    }
  }

  async function internallinks(event) {
    if (event.target.tagName === 'A' && !event.target.getAttribute('target')) {
      event.preventDefault()
      let href = event.target.getAttribute('href')
      let title = href.split('?').slice(-1)[0]
      json = await fetch(database+title).then(res => res.json())
      // window.tab.innerHTML = render(title,json)
      let div = document.createElement('div')
      div.innerHTML = render(title,json)
      let page = div.firstChild
      page.style.left = event.pageX
      page.style.top = event.pageY
      page.style.position = 'absolute'
      // window.tab.insertBefore(page,window.tab.firstChild)
      window.tab.insertBefore(page,null)
      // document.body.scrollTop = 0
      history.pushState({title},'',href)
    } else {
      let keep = event.target.closest('.page')
      console.log('keeping', keep)
      if (keep) {
        while(keep.nextElementSibling) {
          console.log('removing', keep.nextElementSibling)
          keep.nextSibling.remove()
        }
      }
    }
  }

  function render(title,json) {
    if (Object.keys(json).length == 0) {
      trouble('Page unavailable until conversion completed.')
    } else {
      if (title == 'RandomPages') {
        const anyname = () => '*'+names[Math.floor(Math.random()*names.length)]
        json.text = json.text.replace(/\*\w+/g, anyname)
      }
      return `<div class="page" data-title="${title}">${head(title) + markup(json.text,options) + foot(json)}</div>`
    }
  }


// F E A T U R E S

  window.inlinks = async function (e) {
    let title = e.target.closest('.page').dataset.title
    const link = text => `<a href=?${text}>${text}</a>`
    if(!inlinks.length) {inlinks = await infetch}
    let found = inlinks[names.indexOf(title)].map(link => names[link])
    e.target.parentNode.parentNode.nextSibling.innerHTML = `<p>${found.map(link).join('<br>')}</p>`

  }

  function head(title) {
    let words = document.title = title.replace(/([a-z])([A-Z])/g, '$1 $2');
    return [
      '<h1><img src="https://proxy.c2.com/sig/wiki.gif"><div>',
      `<span style="color:blue;cursor: pointer;" onclick=inlinks(event)>${words}</span>`,
      '</div></h1><div></div>'
    ].join('')
  }

  function foot(json) {
    return [
      '<hr>Last edit ',
      json.date
    ].join('')
  }

  window.get = function(e) {
    const link = text => `<a href=?${text}>${text}</a>`
    var want = e.target.value
    if (want.length > 1) {
      var found = names.filter(function (e) { return e.includes(want) })
      if (found.length) {
        return e.target.nextSibling.innerHTML = '<br>'+found.slice(0,500).map(link).join('<br>')
      }
    }
  }
  window.got = function (e) {
    if (!e) e = window.event;
    if ((e.keyCode || e.which) == '13') {
      e.target.value = ''
      e.target.nextSibling.innerHTML = ''
    }
  }

  function titlesearch() {
    return "<input type=text onInput='get(event)' onKeyPress='got(event)'><div></div>"
  }

  window.search = async function (e) {
    let url = `https://proxy.c2.com/cgi/fullSearch`
    if((e.keyCode || e.which) == '13') {
      let text = await fetch(`${url}?search=${e.target.value}`).then(res => res.text())
      let html = text.replace(/ href=wiki/g,' href=').split('<br>').slice(1,-1)
      return e.target.nextSibling.innerHTML = '<br>'+html.join('<br>')
    }
  }

  function fullsearch() {
    return "<input type=text onKeyPress='search(event)'><dev></dev>"
    // return "<form action=\"https://proxy.c2.com/cgi/fullSearch\"><input type=text name=search></form>"
  }


</script>
</body>
</html>
