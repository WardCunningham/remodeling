<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.gif">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<noscript>
  <center>
    <b>notice</b>
    <p>javascript required to view this site</p>
    <b>why</b>
    <p>measured improvement in server performance</p>
    <p>awesome incremental search</p>
  </center>
</noscript>
  
<div id=page>
 <img src="spin.gif">
</div>

<script type=module>

  let names = []
  let json = {}

  let title = (location.search.match(/\w+/)||["WelcomeVisitors"])[0]
  let database = 'https://proxy.c2.com/wiki/remodel/pages/'

  import {configure, markup} from "./markup.js"

  // https://github.com/WardCunningham/remodeling/issues/20
  if (!window.location.origin) {
    window.location.origin = window.location.protocol + '//' +
      window.location.hostname +
      (window.location.port ? (':' + window.location.port) : '');
  }

  try {
    [names, json] = await Promise.all([
      fetch('names.txt').then(res => res.text()).then(text => text.split(/\r?\n/)),
      fetch(database+title).then(res => res.json())
    ])
    configure({names})
    if (Object.keys(json).length == 0) {
      trouble('Page unavailable until conversion completed.')
    } else {
      if (title == 'RandomPages') {
        const anyname = () => '*'+names[Math.floor(Math.random()*names.length)]
        json.text = json.text.replace(/\*\w+/g, anyname)
      }
      window.page.innerHTML = head() + markup(json.text) + foot(json)
    }
  } catch (err) {
    trouble(err.message)
  }


  function trouble (msg) {
    let recourse = "<br>See <a href=https://github.com/WardCunningham/remodeling/issues/2 target=\"_blank\">github</a></p>"
    window.page.innerHTML = "<p>Trouble Encountered<br>" + msg + recourse
  }

  function head() {
    let words = document.title = title.replace(/([a-z])([A-Z])/g, '$1 $2');
    return [
      '<h1><img src="https://proxy.c2.com/sig/wiki.gif"><div><span>',
      '<a href="https://proxy.c2.com/cgi/fullSearch?search=' + title + '" rel=nofollow>' + words + '</a>',
      '</span></div></h1>'
    ].join('')
  }

  function foot(json) {
    return [
      '<hr>Last edit ',
      json.date,
      ', See <a href=https://github.com/WardCunningham/remodeling target="_blank">github</a> about remodeling.'
    ].join('')
  }

</script>
</body>
</html>
