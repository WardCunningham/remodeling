<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.gif">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<noscript>
  <center>
    <b>notice</b>
    <p>javascript required to view this site</p>
    <b>why</b>
    <p>measured improvement in server performance</p>
    <p>awesome incremental search</p>
  </center>
</noscript>
  
<div id=page>
 <img src="spin.gif">
</div>

<script type=module>


// L A U N C H

  let names = []
  let json = {}
  let inlinks = []
  let infetch = fetch('inlinks.json').then(res => res.json())

  let title = (location.search.match(/\w+/)||["WelcomeVisitors"])[0]
  let database = 'https://proxy.c2.com/wiki/remodel/pages/'
  let options = {titlesearch, fullsearch}

  import {markup} from "./markup.js"

  try {
    [names, json] = await Promise.all([
      fetch('names.txt').then(res => res.text()).then(text => text.split(/\r?\n/)),
      fetch(database+title).then(res => res.json())
    ])
    options.names = names
    render(json)
    history.pushState({title},'',location.href)
  } catch (err) {
    trouble(err.message)
  }

  function trouble (msg) {
    let recourse = "<br>See <a href=https://github.com/WardCunningham/remodeling/issues/2 target=\"_blank\">github</a></p>"
    window.page.innerHTML = "<p>Trouble Encountered<br>" + msg + recourse
  }


//  L O O P

  document.addEventListener('click', internallinks)

  window.onpopstate = async function(event) {
    console.log('popstate',event.state)
    if (event.state) {
      title = event.state.title
      json = await fetch(database+title).then(res => res.json())
      render(json)
    } else {
      history.go(-1)
    }
  }

  async function internallinks(event) {
    if (event.target.tagName === 'A' && !event.target.getAttribute('target')) {
      event.preventDefault()
      let href = event.target.getAttribute('href')
      console.log(href)
      title = href.split('?').slice(-1)[0]
      json = await fetch(database+title).then(res => res.json())
      render(json)
      document.body.scrollTop = 0
      history.pushState({title},'',href)
    }
  }

  function render(json) {
    if (Object.keys(json).length == 0) {
      trouble('Page unavailable until conversion completed.')
    } else {
      if (title == 'RandomPages') {
        const anyname = () => '*'+names[Math.floor(Math.random()*names.length)]
        json.text = json.text.replace(/\*\w+/g, anyname)
      }
      window.page.innerHTML = head() + markup(json.text,options) + foot(json)
    }
  }


// F E A T U R E S

  window.inlinks = async function (e) {
    const link = text => `<a href=?${text}>${text}</a>`
    if(!inlinks.length) {inlinks = await infetch}
    let found = inlinks[names.indexOf(title)].map(link => names[link])
    e.target.parentNode.parentNode.nextSibling.innerHTML = `<p>${found.map(link).join('<br>')}</p>`

  }

  function head() {
    let words = document.title = title.replace(/([a-z])([A-Z])/g, '$1 $2');
    return [
      '<h1><img src="https://proxy.c2.com/sig/wiki.gif"><div>',
      `<span style="color:blue;cursor: pointer;" onclick=inlinks(event)>${words}</span>`,
      '</div></h1><div></div>'
    ].join('')
  }

  function foot(json) {
    return [
      '<hr>Last edit ',
      json.date,
      ', See <a href=https://github.com/WardCunningham/remodeling target="_blank">github</a> about remodeling.'
    ].join('')
  }

  window.get = function(e) {
    const link = text => `<a href=?${text}>${text}</a>`
    var want = e.target.value
    if (want.length > 1) {
      var found = names.filter(function (e) { return e.includes(want) })
      if (found.length) {
        return e.target.nextSibling.innerHTML = '<br>'+found.slice(0,500).map(link).join('<br>')
      }
    }
  }
  window.got = function (e) {
    if (!e) e = window.event;
    if ((e.keyCode || e.which) == '13') {
      e.target.value = ''
      e.target.nextSibling.innerHTML = ''
    }
  }

  function titlesearch() {
    return "<input type=text onInput='get(event)' onKeyPress='got(event)'><div></div>"
  }

  window.search = function (e) {
    // return "<form action=\"https://proxy.c2.com/cgi/fullSearch\"><input type=text name=search></form>"

    console.log('search',e.target.value)
  }

  function fullsearch() {
    // return "<input type=text onKeyPress='search(event)'>"
    return "<form action=\"https://proxy.c2.com/cgi/fullSearch\"><input type=text name=search></form>"
  }


</script>
</body>
</html>
